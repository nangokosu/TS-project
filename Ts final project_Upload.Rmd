---
title: "FRED inflation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=F,warning=F,fig.width=10)
```


## Necessary packages 

```{r}
library(quantmod) # Extracting data
library(tsibble)
library(tidyverse)
library(ggplot2)
library(scales)
library(aTSA)
library(dynlm)
library(car)
library(sandwich)
```

## Extracting the data from FRED:

This code chunk below uses the quantmod package to get FRED data via its API.

```{r cars}
cpi=getSymbols('CPIAUCSL',src='FRED',auto.assign=F)['1992-01-01/']
cpi=cpi/cpi[[1]]*100
ppi=getSymbols('PITGCG01USM661N',src='FRED',auto.assign=F)['1992-01-01/']
ppi=ppi/ppi[[1]]*100
energy=getSymbols('PNRGINDEXM',src='FRED',auto.assign=F)['1992-01-01/']
energy=energy/energy[[1]]*100
food=getSymbols('PFOODINDEXM',src='FRED',auto.assign=F)['1992-01-01/']
food=food/food[[1]]*100
used_cars=getSymbols('CUSR0000SETA02',src='FRED',auto.assign=F)['1992-01-01/']
used_cars=used_cars/used_cars[[1]]*100
Unemployment=getSymbols('UNRATE',src='FRED',auto.assign=F)['1992-01-01/']
Electricity_avg=getSymbols('APU000072610',src='FRED',auto.assign=F)['1992-01-01/']
Electricity_avg=Electricity_avg/Electricity_avg[[1]]*100
```

## Merging:

This code chunk merges the individual extracted xts series into one object
```{r pressure, echo=FALSE}
list_ts=list(cpi,ppi,energy,food,used_cars,housing, Unemployment, Electricity_avg)
final_xts=do.call(merge,list_ts)
# Final object omitting all NA variables due to lack of historical data
final_xts=na.approx(final_xts) # Linear approximation
final_xts=na.locf(final_xts)
final_ts_df=final_xts%>%fortify.zoo()%>%as_tsibble()
colnames(final_ts_df)=c("Date","CPI","PPI","Energy","Food","Used_cars","Housing_prices", "Unemployment_Rate", "AvgElectricityPrices")
colnames(final_xts)=c("CPI","PPI","Energy","Food","Used_cars","Housing_prices", "Unemployment_Rate", "AvgElectricityPrices")
```


## EDA:
For all indices
```{r,fig.width=10}
ggplot(final_ts_df,aes(x=Date))+
  geom_line(aes(y=PPI,color="PPI"))+
  geom_line(aes(y=CPI,color="CPI"))+
  geom_line(aes(y=Energy,color="Global price of energy index"))+
  geom_line(aes(y=Food,color="Global price of Food index"))+
  geom_line(aes(y=Used_cars,color="Used car price index"))+
  geom_line(aes(y=Housing_prices,color="Housing price index"))+
  geom_line(aes(y=AvgElectricityPrices,color="Average Electricity Prices"))+
  theme_bw()+ylab("Index value (base = 100)")+xlab(NULL)+
  scale_x_date(date_breaks="4 year")+labs(colour="Index series")+ggtitle("Index series from 1992-01-01")+
  theme(text=element_text(size=12))
```
```{r,fig.width=10}
ggplot(final_ts_df,aes(x=Date))+
  geom_line(aes(y=Unemployment))+
  theme_bw()+ylab("Index value (base = 100)")+xlab(NULL)+
  scale_x_date(date_breaks="4 year")+labs(colour="Index series")+ggtitle("Index series of unemployment rate from 1992-01-01")+
  theme(text=element_text(size=12))
```



```{r}
ggplot(data=NULL,aes(x=final_ts_df$Date[-1]))+
  geom_line(aes(y=diff(log(final_ts_df$PPI)),color="PPI"))+
  geom_line(aes(y=diff(log(final_ts_df$CPI)),color="CPI"))+
  geom_line(aes(y=diff(log(final_ts_df$Energy)),color="Global price of energy index"))+
  geom_line(aes(y=diff(log(final_ts_df$Food)),color="Global price of Food index"))+
  geom_line(aes(y=diff(log(final_ts_df$Used_cars)),color="Used car price index"))+
  geom_line(aes(y=diff(log(final_ts_df$Housing_prices)),color="Housing price index"))+
  geom_line(aes(y=diff(log(final_ts_df$Unemployment_Rate)),color="U.S Unemployment Rate"))+
  geom_line(aes(y=diff(log(final_ts_df$AvgElectricityPrices)),color="Average U.S City Electricity Prices"))+
  theme_bw()+ylab("Percentage change")+xlab(NULL)+
  scale_x_date(date_breaks="4 year")+
  scale_y_continuous(labels=scales::percent,breaks=scales::pretty_breaks(n=20))+
  labs(colour="Index series")+ggtitle("Index series from 1992-01-01")
```
Big Spike for Unemployment during covid that might have a significant impact on model. 

## Checking for stationarity and persistence after first differencing of log variables:

```{r,fig.height=10}
par(mar = c(3,3,5,5))
par(mfrow=c(3,3))
acf(diff(log(final_ts_df$PPI)),main="ACF for PPI")
acf(diff(log(final_ts_df$CPI)),main="ACF for CPI")
acf(diff(log(final_ts_df$Energy)),main="ACF for Energy")
acf(diff(log(final_ts_df$Food)),main="ACF for Food")
acf(diff(log(final_ts_df$Housing_prices)),main="ACF for Housing")
acf(diff(log(final_ts_df$Used_cars)),main="ACF for Used cars")
acf(diff(final_ts_df$Unemployment_Rate),main="ACF for Unemployment")
acf(diff(log(final_ts_df$AvgElectricityPrices)),main="ACF for Avg. U.S City Electricity Prices")
```


## Lag importance examination:
Our variable examination process consists of three steps:
1. Running a regression of our variables with the appropriate number of lags against CPI and PPI to determine if the lags have any statistically significant effect.
2. Use a model F-test to determine if a model without lags could fit as well as a model with lags.


Food and Energy

```{r}
final_ts_df['log_Energy']=log(final_ts_df$Energy)
final_ts_df['diff_log_Energy']=difference(final_ts_df$log_Energy)
final_ts_df['lag_diff_log_Energy']=lag(final_ts_df$diff_log_Energy)
final_ts_df['log_Food']=log(final_ts_df$Food)
final_ts_df['diff_log_Food']=difference(final_ts_df$log_Food)
final_ts_df['lag_diff_log_Food']=lag(final_ts_df$diff_log_Food)
final_ts_df['log_CPI']=log(final_ts_df$CPI)
final_ts_df['diff_log_CPI']=difference(final_ts_df$log_CPI)
final_ts_df['log_PPI']=log(final_ts_df$PPI)
final_ts_df['diff_log_PPI']=difference(final_ts_df$log_PPI)
```

Model Building - CPI vs Energy and Food

```{r}
lag_CPI_Food_Energy=lm(diff_log_CPI~diff_log_Energy+lag_diff_log_Energy+diff_log_Food+lag_diff_log_Food,data=final_ts_df)
```

Model Evaluation - CPI vs Energy and Food

```{r}
summary(lag_CPI_Food_Energy)
plot(lag_CPI_Food_Energy)
acf(lag_CPI_Food_Energy$residuals)
linearHypothesis(lag_CPI_Food_Energy,c("lag_diff_log_Energy=0","lag_diff_log_Food=0"),vcov=vcovHAC)
```

Model Building - PPI vs Energy and Food
```{r}
lag_PPI_Food_Energy=lm(diff_log_PPI~diff_log_Energy+lag_diff_log_Energy+diff_log_Food+lag_diff_log_Food,data=final_ts_df)
```

Model Evaluation - PPI vs Energy and Food
```{r}
summary(lag_PPI_Food_Energy)
plot(lag_PPI_Food_Energy)
acf(lag_PPI_Food_Energy$residuals)
linearHypothesis(lag_PPI_Food_Energy,c("lag_diff_log_Energy=0","lag_diff_log_Food=0"),vcov=vcovHAC)
```

For Energy and Food, we found that using up to their first lags gives the most explanatory power.

Housing and Used Cars

```{r}
final_ts_df['log_Housing'] = log(final_ts_df$Housing_prices)
final_ts_df['diff_log_Housing'] = difference(final_ts_df$log_Housing)
final_ts_df['lag_12_diff_log_Housing'] = lag(final_ts_df$diff_log_Housing, k = 12)
final_ts_df['log_Used_Cars'] = log(final_ts_df$Used_cars)
final_ts_df['diff_log_Used_Cars'] = difference(final_ts_df$log_Used_Cars)
final_ts_df['lag_diff_log_Used_Cars'] = lag(final_ts_df$diff_log_Used_Cars)
```

Model Building - CPI vs Housing and Used Cars

```{r}
lag_CPI_Housing_Used_Cars <- lm ( diff_log_CPI ~ diff_log_Housing + lag_12_diff_log_Housing + diff_log_Used_Cars + lag_diff_log_Used_Cars, data = final_ts_df)
```

Model Evaluation - CPI vs Housing and Used Cars

```{r}
summary(lag_CPI_Housing_Used_Cars)
plot(lag_CPI_Housing_Used_Cars)
acf(lag_CPI_Hosuing_Used_Cars$residuals)
linearHypothesis(lag_CPI_Housing_Used_Cars,c("lag_12_diff_log_Housing=0","lag_diff_log_Used_Cars=0"),vcov=vcovHAC)
```

Model Building - PPi vs Housing and Used Cars

```{r}
lag_PPI_Housing_Used_Cars <- lm ( diff_log_PPI ~ diff_log_Housing + lag_12_diff_log_Housing + diff_log_Used_Cars + lag_diff_log_Used_Cars, data = final_ts_df)
```

Model Evaluation - PPI vs Housing and Used Cars
```{r}
summary(lag_PPI_Housing_Used_Cars)
plot(lag_PPI_Housing_Used_Cars)
acf(lag_PPI_Housing_Used_Cars$residuals)
linearHypothesis(lag_PPI_Housing_Used_Cars,c("lag_12_diff_log_Housing=0","lag_diff_log_Used_Cars=0"),vcov=vcovHAC)
```

For both Used Cars and Housing, lags do not add explanatory effect.

Unemployment and Electricity

```{r}
final_ts_df['diff_Unemployment']=difference(final_ts_df$Unemployment_Rate)
final_ts_df['lag_diff_Unemployment'] = lag(final_ts_df['diff_Unemployment'])
final_ts_df['log_AvgElectricityPrices']=log(final_ts_df$AvgElectricityPrices)
final_ts_df['diff_log_AvgElectricityPrices']=difference(final_ts_df$log_AvgElectricityPrices)
final_ts_df['lag_4_diff_log_AvgElectricityPrices'] = lag(final_ts_df$diff_log_AvgElectricityPrices, k = 4)
```

Model Building - CPI vs Unemployment & Electricity Prices
```{r}
lag_CPI_Unemployment_AvgElectricityPrices <- lm ( diff_log_CPI ~ diff_Unemployment + lag_diff_Unemployment + diff_log_AvgElectricityPrices + lag_4_diff_log_AvgElectricityPrices, data = final_ts_df)
```

Model Evaluation - CPI vs Unemployment & Electricity Prices
```{r}
summary(lag_CPI_Unemployment_AvgElectricityPrices)
plot(lag_CPI_Unemployment_AvgElectricityPrices)
acf(lag_CPI_Unemployment_AvgElectricityPrices$residuals)
linearHypothesis(lag_CPI_Unemployment_AvgElectricityPrices,c("lag_4_diff_log_AvgElectricityPrices =0"),vcov=vcovHAC)
```

Model Building - PPI vs Unemployment & Electricity Prices

```{r}
lag_PPI_Unemployment_AvgElectricityPrices<- lm ( diff_log_PPI ~ diff_Unemployment + lag_diff_Unemployment + diff_log_AvgElectricityPrices + lag_4_diff_log_AvgElectricityPrices, data = final_ts_df)
```

Model Evaluation - PPI vs Unemployment & Electricity Prices

```{r}
summary(lag_PPI_Unemployment_AvgElectricityPrices)
plot(lag_PPI_Unemployment_AvgElectricityPrices)
acf(lag_PPI_Unemployment_AvgElectricityPrices$residuals)
linearHypothesis(lag_PPI_Unemployment_AvgElectricityPrices,c("lag_4_diff_log_AvgElectricityPrices =0"),vcov=vcovHAC)
```

For Unemployment Rate and Average Electricity Prices, lags do not add any explanatory effect.

## Final model
We fit a model using all six variables with no lags, and the same model but including the first lags for Energy and Food Price as determined above.

### For CPI
```{r}
complete_fit_CPI <- lm( diff_log_CPI ~ diff_log_Energy  + diff_log_Food + diff_log_Housing +   diff_log_Used_Cars + diff_Unemployment + diff_log_AvgElectricityPrices, data = final_ts_df)

complete_lag_fit_CPI <- lm( diff_log_CPI ~ diff_log_Energy + lag_diff_log_Energy + diff_log_Food + lag_diff_log_Food + diff_log_Housing  +  diff_log_Used_Cars +  diff_Unemployment + lag_diff_Unemployment + diff_log_AvgElectricityPrices, data = final_ts_df)
```

```{r,fig.height=10,fig.width=10}
par(mar = c(2,2,5,5))
par(mfrow=c(2,2))
plot(complete_fit_CPI,which=c(1))
plot(complete_lag_fit_CPI,which=c(1))
acf(complete_fit_CPI$residuals)
acf(complete_lag_fit_CPI$residuals)
```


```{r}
summary(complete_fit_CPI)
summary(complete_lag_fit_CPI)
AIC(complete_fit_CPI)
AIC(complete_lag_fit_CPI)
```


### FOr PPI
```{r}
complete_fit_PPI <- lm( diff_log_PPI ~ diff_log_Energy  + diff_log_Food + diff_log_Housing +   diff_log_Used_Cars + diff_Unemployment + diff_log_AvgElectricityPrices, data = final_ts_df)

complete_lag_fit_PPI <- lm( diff_log_PPI ~ diff_log_Energy + lag_diff_log_Energy + diff_log_Food + lag_diff_log_Food + diff_log_Housing  +  diff_log_Used_Cars +  diff_Unemployment + diff_log_AvgElectricityPrices, data = final_ts_df)
```

```{r,fig.height=10,fig.width=10}
par(mar = c(2,2,5,5))
par(mfrow=c(2,2))
plot(complete_fit_PPI,which=c(1))
plot(complete_lag_fit_PPI,which=c(1))
acf(complete_fit_PPI$residuals)
acf(complete_lag_fit_PPI$residuals)
```
```{r}
summary(complete_fit_PPI)
summary(complete_lag_fit_PPI)
AIC(complete_fit_PPI)
AIC(complete_lag_fit_PPI)
```

```{r}
vif(complete_lag_fit_CPI)
vif(complete_lag_fit_PPI)

```
